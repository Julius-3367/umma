import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import { SnackbarProvider } from 'notistack';
import { Provider } from 'react-redux';
import { PersistGate } from 'redux-persist/integration/react';
import { store, persistor } from './app/store';

// Import theme provider and style utilities
import ThemeProvider from './providers/ThemeProvider.jsx';
import { loadAllStyles, monitorStylePerformance } from './utils/styleLoader.js';
import { theme } from './theme/theme.js';

// Import main app component
import App from './App.jsx';

// Import Tailwind CSS (ensure it loads first)
import './index.css';

/**
 * Enhanced App Wrapper with comprehensive style loading
 * Ensures all themes and styles are loaded before app initialization
 */
const AppWrapper = () => {
  return (
    <ThemeProvider>
      <BrowserRouter>
        <SnackbarProvider
          maxSnack={3}
          anchorOrigin={{
            vertical: 'top',
            horizontal: 'right',
          }}
          autoHideDuration={5000}
          preventDuplicate
          dense
          style={{
            fontFamily: theme.typography.fontFamily,
          }}
        >
          <App />
        </SnackbarProvider>
      </BrowserRouter>
    </ThemeProvider>
  );
};

/**
 * Application initialization with style pre-loading
 */
const initializeApp = async () => {
  console.log('üöÄ Initializing UMSL Labor Mobility Platform...');

  // Initialize demo mode if environment variable is set
  if (import.meta.env.VITE_DEMO_MODE === 'true') {
    console.log('üé≠ Running in demo mode with mock data');
  }

  // Start performance monitoring in development
  if (import.meta.env.DEV) {
    monitorStylePerformance();
  }

  try {
    // Ensure all styles are loaded before rendering
    console.log('üì¶ Loading theme and styles...');
    await loadAllStyles(theme);

    // Get root element
    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error('Root element not found');
    }

    // Create React root and render app
    const root = ReactDOM.createRoot(rootElement);

    root.render(
      <React.StrictMode>
        <Provider store={store}>
          <PersistGate loading={null} persistor={persistor}>
            <AppWrapper />
          </PersistGate>
        </Provider>
      </React.StrictMode>
    );

    console.log('‚úÖ App initialized successfully');

    // Add global error boundary for unhandled errors
    window.addEventListener('unhandledrejection', event => {
      console.error('Unhandled promise rejection:', event.reason);
    });

    window.addEventListener('error', event => {
      console.error('Global error:', event.error);
    });
  } catch (error) {
    console.error('‚ùå Failed to initialize app:', error);

    // Fallback: render error message
    const rootElement = document.getElementById('root');
    if (rootElement) {
      rootElement.innerHTML = `
        <div style="
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          font-family: 'Inter', sans-serif;
          background-color: #f8fafc;
          color: #1e293b;
          text-align: center;
          padding: 20px;
        ">
          <div>
            <h1 style="color: #ef4444; font-size: 1.5rem; margin-bottom: 1rem;">
              Failed to Load Application
            </h1>
            <p style="margin-bottom: 1rem; color: #64748b;">
              There was an error loading the UMSL Labor Mobility platform.
            </p>
            <button
              onclick="window.location.reload()"
              style="
                background-color: #3B82F6;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 500;
                cursor: pointer;
                font-size: 0.875rem;
              "
            >
              Reload Page
            </button>
            <details style="margin-top: 2rem; text-align: left;">
              <summary style="cursor: pointer; color: #64748b;">Technical Details</summary>
              <pre style="
                background: #f1f5f9;
                padding: 1rem;
                border-radius: 6px;
                margin-top: 0.5rem;
                font-size: 0.75rem;
                overflow: auto;
              ">${error.message}</pre>
            </details>
          </div>
        </div>
      `;
    }
  }
};

// Start the application
initializeApp();
