// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// -----------------------------
/// ENUMERATIONS
/// -----------------------------



































/// -----------------------------
/// CORE ENTITIES
/// -----------------------------

model Tenant {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  code        String   @unique
  branding    String?
  contactInfo String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles                   Role[]
  users                   User[]
  userTenants             UserTenant[]
  activityLogs            ActivityLog[]
  candidates              Candidate[]
  candidateDocuments      CandidateDocument[]
  courses                 Course[]
  companies               Company[]
  enrollments             Enrollment[]
  attendanceRecords       AttendanceRecord[]
  attendanceAppeals       AttendanceAppeal[]
  assessments             Assessment[]
  certificates            Certificate[]
  certificateTemplates    CertificateTemplate[]
  vettingRecords          VettingRecord[]
  placements              Placement[]
  candidatePipelineEvents CandidatePipelineEvent[]
  jobOpenings             JobOpening[]
  agents                  Agent[]
  brokers                 Broker[]
  payments                Payment[]
  invoices                Invoice[]
  notifications           Notification[]
  settings                Setting[]
  reportJobs              ReportJob[]
  messages                Message[]
  supportTickets          SupportTicket[]
  cohorts                 Cohort[]

  @@map("tenants")
}

// User Roles
model Role {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  permissions String?
  systemRole  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenantId    Int?

  tenant      Tenant?      @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users       User[]
  userTenants UserTenant[]

  @@unique([tenantId, name])
  @@map("roles")
}

// User Management
model User {
  id               Int        @id @default(autoincrement())
  email            String     @unique
  password         String
  refreshToken     String?    
  firstName        String
  lastName         String
  phone            String?
  status           String @default("ACTIVE")
  authProvider     String     @default("local")
  authId           String?
  twoFactorEnabled Boolean    @default(false)
  lastLogin        DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  tenantId         Int?
  roleId           Int
  createdBy        Int?
  updatedBy        Int?

  role                   Role                     @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenant                 Tenant?                  @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sessions               Session[]
  activityLogs           ActivityLog[]
  createdUsers           User[]                   @relation("UserCreatedBy")
  updatedUsers           User[]                   @relation("UserUpdatedBy")
  createdByUser          User?                    @relation("UserCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser          User?                    @relation("UserUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userTenants            UserTenant[]
  agentsCreated          Agent[]                  @relation("AgentCreatedBy")
  agentsUpdated          Agent[]                  @relation("AgentUpdatedBy")
  brokersCreated         Broker[]                 @relation("BrokerCreatedBy")
  brokersUpdated         Broker[]                 @relation("BrokerUpdatedBy")
  candidateProfile       Candidate?               @relation("CandidateAccount")
  candidatesCreated      Candidate[]              @relation("CandidateCreatedBy")
  candidatesUpdated      Candidate[]              @relation("CandidateUpdatedBy")
  candidateDocuments     CandidateDocument[]      @relation("CandidateDocumentUploadedBy")
  coursesCreated         Course[]                 @relation("CourseCreatedBy")
  coursesUpdated         Course[]                 @relation("CourseUpdatedBy")
  enrollmentsCreated     Enrollment[]             @relation("EnrollmentCreatedBy")
  enrollmentsUpdated     Enrollment[]             @relation("EnrollmentUpdatedBy")
  attendanceRecorded     AttendanceRecord[]       @relation("AttendanceRecordedBy")
  assessmentsCreated     Assessment[]             @relation("AssessmentCreatedBy")
  assessmentsUpdated     Assessment[]             @relation("AssessmentUpdatedBy")
  certificatesIssued     Certificate[]            @relation("CertificateIssuedBy")
  templatesCreated       CertificateTemplate[]    @relation("TemplateCreatedBy")
  vettingCreated         VettingRecord[]          @relation("VettingCreatedBy")
  vettingUpdated         VettingRecord[]          @relation("VettingUpdatedBy")
  vettingVerified        VettingRecord[]          @relation("VettingVerifiedBy")
  vettingReviewed        VettingRecord[]          @relation("VettingReviewedBy")
  placementsCreated      Placement[]              @relation("PlacementCreatedBy")
  placementsUpdated      Placement[]              @relation("PlacementUpdatedBy")
  placementsManaged      Placement[]              @relation("PlacementOfficer")
  jobOpeningsCreated     JobOpening[]             @relation("JobOpeningRecruiter")
  pipelineEventsAuthored CandidatePipelineEvent[] @relation("PipelineEventAuthor")
  paymentsCreated        Payment[]                @relation("PaymentCreatedBy")
  paymentsUpdated        Payment[]                @relation("PaymentUpdatedBy")
  invoicesCreated        Invoice[]                @relation("InvoiceCreatedBy")
  invoicesUpdated        Invoice[]                @relation("InvoiceUpdatedBy")
  notificationsSent      Notification[]           @relation("NotificationCreatedBy")
  notificationsUpdated   Notification[]           @relation("NotificationUpdatedBy")
  notifications          Notification[]           @relation("NotificationRecipient")
  settingsCreated        Setting[]                @relation("SettingCreatedBy")
  settingsUpdated        Setting[]                @relation("SettingUpdatedBy")
  companiesCreated       Company[]                @relation("CompanyCreatedBy")
  companiesUpdated       Company[]                @relation("CompanyUpdatedBy")
  messagesSent           Message[]                @relation("MessageSender")
  messagesReceived       Message[]                @relation("MessageRecipient")
  ticketsCreated         SupportTicket[]          @relation("TicketCreatedBy")
  ticketsAssigned        SupportTicket[]          @relation("TicketAssignedTo")
  ticketComments         SupportTicketComment[]
  appealsReviewed        AttendanceAppeal[]       @relation("AppealReviewer")

  // Cohort relations
  cohortsAsLead             Cohort[]                @relation("CohortLeadTrainer")
  cohortsCreated            Cohort[]                @relation("CohortCreatedBy")
  cohortsUpdated            Cohort[]                @relation("CohortUpdatedBy")
  cohortEnrollmentsReviewed CohortEnrollment[]      @relation("CohortEnrollmentReviewer")
  sessionsAsFacilitator     CohortSession[]         @relation("SessionFacilitator")
  sessionsCreated           CohortSession[]         @relation("SessionCreatedBy")
  sessionsUpdated           CohortSession[]         @relation("SessionUpdatedBy")
  cohortSummariesGenerated  CohortProgressSummary[]

  @@map("users")
}

// Session Management for JWT refresh tokens
model Session {
  id        Int      @id @default(autoincrement())
  token     String   @unique 
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("sessions")
}

// Activity Logging
model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  tenantId  Int?
  action    String
  module    String?
  resource  String?
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId, module])
  @@map("activity_logs")
}

model UserTenant {
  id        Int      @id @default(autoincrement())
  userId    Int
  tenantId  Int
  roleId    Int
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenant Tenant @relation(fields: [tenantId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, tenantId])
  @@map("user_tenants")
}

model Agent {
  id                  Int       @id @default(autoincrement())
  tenantId            Int
  name                String
  agentCode           String
  contactPerson       String?
  email               String?
  phone               String?
  address             String?
  country             String?
  idOrBusinessCertUrl String?
  dateJoined          DateTime?
  feePerCandidate     Decimal?  
  paymentTerms        String?
  discountRate        Float?
  paymentMethod       String?
  metadata            String?
  createdBy           Int?
  updatedBy           Int?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  tenant        Tenant       @relation(fields: [tenantId], references: [id])
  candidates    Candidate[]
  enrollments   Enrollment[]
  placements    Placement[]
  payments      Payment[]
  createdByUser User?        @relation("AgentCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?        @relation("AgentUpdatedBy", fields: [updatedBy], references: [id])

  @@unique([tenantId, agentCode])
  @@index([tenantId, name])
  @@map("agents")
}

model Broker {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  name             String
  brokerCode       String
  contactDetails   String?
  referrerType     String?
  dateJoined       DateTime?
  commissionType   String?
  commissionAmount Decimal?  
  paymentTerms     String?
  metadata         String?
  createdBy        Int?
  updatedBy        Int?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant        Tenant      @relation(fields: [tenantId], references: [id])
  candidates    Candidate[]
  placements    Placement[]
  payments      Payment[]
  createdByUser User?       @relation("BrokerCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?       @relation("BrokerUpdatedBy", fields: [updatedBy], references: [id])

  @@unique([tenantId, brokerCode])
  @@index([tenantId, name])
  @@map("brokers")
}

model Candidate {
  id                     Int             @id @default(autoincrement())
  tenantId               Int
  userId                 Int?            @unique
  fullName               String
  gender                 String?
  dob                    DateTime?
  nationalIdPassport     String?
  county                 String?
  maritalStatus          String?
  highestEducation       String?
  languages              String?
  relevantSkills         String?
  profilePhotoUrl        String?
  passportCopyUrl        String?
  idCopyUrl              String?
  supportingCertificates String?
  previousEmployer       String?
  previousRole           String?
  previousDuration       String?
  referenceContact       String?
  applyingViaAgent       Boolean         @default(false)
  agentId                Int?
  referredByBroker       Boolean         @default(false)
  brokerId               Int?
  feeAgreementConfirmed  Boolean         @default(false)
  medicalClearanceUrl    String?
  policeClearanceUrl     String?
  languageTestScore      Float?
  interviewStatus        String?
  preferredCountry       String?
  jobTypePreference      String?
  willingToRelocate      Boolean         @default(false)
  declarationConfirmed   Boolean         @default(false)
  status                 String @default("APPLIED")
  createdBy              Int?
  updatedBy              Int?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  tenant            Tenant                   @relation(fields: [tenantId], references: [id])
  user              User?                    @relation("CandidateAccount", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  agent             Agent?                   @relation(fields: [agentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  broker            Broker?                  @relation(fields: [brokerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdByUser     User?                    @relation("CandidateCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser     User?                    @relation("CandidateUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  enrollments       Enrollment[]
  vetting           VettingRecord[]
  placements        Placement[]
  documents         CandidateDocument[]
  payments          Payment[]
  appeals           AttendanceAppeal[]
  pipelineEvents    CandidatePipelineEvent[]
  cohortEnrollments CohortEnrollment[]

  @@index([tenantId, status])
  @@index([tenantId, fullName])
  @@map("candidates")
}

model CandidateDocument {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  candidateId  Int
  documentType String
  fileUrl      String
  uploadedBy   Int?
  uploadedAt   DateTime @default(now())

  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  candidate      Candidate @relation(fields: [candidateId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  uploadedByUser User?     @relation("CandidateDocumentUploadedBy", fields: [uploadedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId, documentType])
  @@map("candidate_documents")
}

model CandidatePipelineEvent {
  id            Int              @id @default(autoincrement())
  tenantId      Int
  candidateId   Int
  fromStage     String?
  toStage       String
  comment       String?          
  isBlocked     Boolean          @default(false)
  blockerReason String?
  createdBy     Int?
  createdAt     DateTime         @default(now())

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  author    User?     @relation("PipelineEventAuthor", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([tenantId, candidateId])
  @@map("candidate_pipeline_events")
}

model Course {
  id           Int       @id @default(autoincrement())
  tenantId     Int
  title        String
  code         String
  category     String?
  description  String?
  durationDays Int?
  startDate    DateTime?
  endDate      DateTime?
  trainers     String?
  capacity     Int?
  location     String?
  status       String?
  createdBy    Int?
  updatedBy    Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  enrollments   Enrollment[]
  attendance    AttendanceRecord[]
  assessments   Assessment[]
  certificates  Certificate[]
  cohorts       Cohort[]
  createdByUser User?              @relation("CourseCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?              @relation("CourseUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([tenantId, code])
  @@index([tenantId, title])
  @@map("courses")
}

/// Company / Employer profiles
model Company {
  id            Int      @id @default(autoincrement())
  tenantId      Int
  name          String
  email         String?
  phone         String?
  country       String?
  industry      String?
  contactPerson String?
  website       String?
  address       String?
  status        String?  @default("ACTIVE")
  metadata      String?
  createdBy     Int?
  updatedBy     Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id])
  createdByUser User?  @relation("CompanyCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?  @relation("CompanyUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId, status])
  @@index([tenantId, name])
  @@map("companies")
}

model Enrollment {
  id               Int              @id @default(autoincrement())
  tenantId         Int
  courseId         Int
  candidateId      Int
  applicationId    Int?
  enrollmentDate   DateTime?
  enrollmentStatus String @default("APPLIED")
  paymentStatus    String?   @default("PENDING")
  agentId          Int?
  admissionStatus  String?
  createdBy        Int?
  updatedBy        Int?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  course            Course             @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  candidate         Candidate          @relation(fields: [candidateId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  agent             Agent?             @relation(fields: [agentId], references: [id])
  attendance        AttendanceRecord[]
  assessments       Assessment[]
  certificates      Certificate[]
  cohortEnrollments CohortEnrollment[]
  createdByUser     User?              @relation("EnrollmentCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser     User?              @relation("EnrollmentUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([tenantId, courseId, candidateId])
  @@index([tenantId, enrollmentStatus])
  @@map("enrollments")
}

model AttendanceRecord {
  id            Int              @id @default(autoincrement())
  tenantId      Int
  courseId      Int
  enrollmentId  Int
  date          DateTime
  sessionNumber Int?
  status        String
  remarks       String?
  recordedBy    Int?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  tenant         Tenant             @relation(fields: [tenantId], references: [id])
  course         Course             @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  enrollment     Enrollment         @relation(fields: [enrollmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recordedByUser User?              @relation("AttendanceRecordedBy", fields: [recordedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  appeals        AttendanceAppeal[]

  @@unique([tenantId, enrollmentId, date])
  @@index([tenantId, courseId, date])
  @@map("attendance_records")
}

/// Attendance Appeals - Candidates can appeal attendance records
model AttendanceAppeal {
  id                  Int               @id @default(autoincrement())
  tenantId            Int
  attendanceRecordId  Int
  candidateId         Int
  reason              String            
  supportingDocuments String?            // JSON array of file paths
  status              String      @default("PENDING")
  reviewedBy          Int?
  reviewedAt          DateTime?
  reviewerComments    String?           
  originalStatus      String
  requestedStatus     String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  attendanceRecord AttendanceRecord @relation(fields: [attendanceRecordId], references: [id], onDelete: Cascade)
  candidate        Candidate        @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  reviewer         User?            @relation("AppealReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([tenantId, candidateId])
  @@index([tenantId, status])
  @@index([attendanceRecordId])
  @@map("attendance_appeals")
}

model JobOpening {
  id            Int       @id @default(autoincrement())
  tenantId      Int
  recruiterId   Int?
  jobTitle      String
  employerName  String?
  location      String?
  jobType       String?
  priority      String?
  openings      Int?      @default(1)
  salaryRange   String?
  status        String    @default("OPEN")
  interviewDate DateTime?
  description   String?   
  requirements  String?   
  metadata      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  recruiter  User?       @relation("JobOpeningRecruiter", fields: [recruiterId], references: [id], onDelete: SetNull)
  placements Placement[]

  @@index([tenantId, status])
  @@map("job_openings")
}

/// Report Jobs (persisted)
model ReportJob {
  id          Int       @id @default(autoincrement())
  tenantId    Int?
  type        String
  format      String    @default("csv")
  status      String    @default("queued")
  downloadUrl String?
  error       String?
  meta        String?
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId, status])
  @@map("report_jobs")
}

model Assessment {
  id              Int               @id @default(autoincrement())
  tenantId        Int
  courseId        Int
  enrollmentId    Int
  assessmentTitle String?           
  assessmentType  String            
  maxScore        Float?
  score           Float?
  percentage      Float?
  resultCategory  String?
  trainerComments String?           
  feedback        String?           
  date            DateTime?
  createdBy       Int?
  updatedBy       Int?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  tenant        Tenant     @relation(fields: [tenantId], references: [id])
  course        Course     @relation(fields: [courseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdByUser User?      @relation("AssessmentCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?      @relation("AssessmentUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId, courseId])
  @@index([enrollmentId])
  @@map("assessments")
}

model Certificate {
  id                Int               @id @default(autoincrement())
  tenantId          Int
  enrollmentId      Int?
  templateId        Int?
  certificateNumber String            @unique
  issueDate         DateTime
  expiryDate        DateTime?
  status            String @default("PENDING")
  grade             String?
  remarks           String?           
  qrCode            String?           
  digitalSignature  String?           
  pdfUrl            String?
  issuedBy          Int?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  tenant       Tenant               @relation(fields: [tenantId], references: [id])
  enrollment   Enrollment?          @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  template     CertificateTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  issuedByUser User?                @relation("CertificateIssuedBy", fields: [issuedBy], references: [id], onDelete: SetNull)
  Course       Course?              @relation(fields: [courseId], references: [id])
  courseId     Int?

  @@unique([tenantId, enrollmentId])
  @@index([tenantId, status])
  @@index([certificateNumber])
  @@map("certificates")
}

model CertificateTemplate {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String
  description String?  
  design      String?
  content     String?
  isActive    Boolean  @default(true)
  createdBy   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  createdByUser User?         @relation("TemplateCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  certificates  Certificate[]

  @@unique([tenantId, name])
  @@map("certificate_templates")
}

model VettingRecord {
  id                          Int           @id @default(autoincrement())
  tenantId                    Int
  candidateId                 Int
  policeClearanceNo           String?
  policeDocumentUrl           String?
  medicalReportNo             String?
  medicalReportUrl            String?
  medicalStatus               String?
  vaccinationProofUrl         String?
  languageTestPassed          Boolean?
  interviewReadinessChecklist String?
  verificationOfficerId       Int?
  vettingStatus               String @default("PENDING")
  reviewedBy                  Int?
  reviewDate                  DateTime?
  comments                    String?
  createdBy                   Int?
  updatedBy                   Int?
  createdAt                   DateTime      @default(now())
  updatedAt                   DateTime      @updatedAt

  tenant              Tenant    @relation(fields: [tenantId], references: [id])
  candidate           Candidate @relation(fields: [candidateId], references: [id])
  verificationOfficer User?     @relation("VettingVerifiedBy", fields: [verificationOfficerId], references: [id])
  reviewedByUser      User?     @relation("VettingReviewedBy", fields: [reviewedBy], references: [id])
  createdByUser       User?     @relation("VettingCreatedBy", fields: [createdBy], references: [id])
  updatedByUser       User?     @relation("VettingUpdatedBy", fields: [updatedBy], references: [id])

  @@index([tenantId, vettingStatus])
  @@map("vetting_records")
}

model Placement {
  id                     Int             @id @default(autoincrement())
  tenantId               Int
  candidateId            Int
  agentId                Int?
  brokerId               Int?
  recruitingAgency       String?
  jobRoleOffered         String?
  country                String?
  employerName           String?
  interviewDate          DateTime?
  interviewResult        String?
  offerLetterUrl         String?
  visaApplicationNo      String?
  visaStatus             String?
  travelDate             DateTime?
  flightDetails          String?
  recruitmentOfficerId   Int?
  trainingFeeBalance     Decimal?        
  agentCommission        Decimal?        
  brokerFee              Decimal?        
  contractUploaded       Boolean         @default(false)
  paymentConfirmation    Boolean         @default(false)
  candidateNotified      Boolean         @default(false)
  acceptanceConfirmed    Boolean         @default(false)
  placementStatus        String @default("INITIATED")
  placementCompletedDate DateTime?
  createdBy              Int?
  updatedBy              Int?
  jobOpeningId           Int?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  tenant             Tenant      @relation(fields: [tenantId], references: [id])
  candidate          Candidate   @relation(fields: [candidateId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  agent              Agent?      @relation(fields: [agentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  broker             Broker?     @relation(fields: [brokerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recruitmentOfficer User?       @relation("PlacementOfficer", fields: [recruitmentOfficerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdByUser      User?       @relation("PlacementCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser      User?       @relation("PlacementUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  jobOpening         JobOpening? @relation(fields: [jobOpeningId], references: [id], onDelete: SetNull)
  payments           Payment[]

  @@index([tenantId, placementStatus])
  @@map("placements")
}

model Payment {
  id            Int            @id @default(autoincrement())
  tenantId      Int
  referenceNo   String
  payerId       Int?
  type          String
  amount        Decimal        
  currency      String?        @default("KES")
  method        String?
  status        String  @default("PENDING")
  metadata      String?
  invoicePdfUrl String?
  agentId       Int?
  brokerId      Int?
  candidateId   Int?
  placementId   Int?
  createdBy     Int?
  updatedBy     Int?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  tenant        Tenant     @relation(fields: [tenantId], references: [id])
  agent         Agent?     @relation(fields: [agentId], references: [id])
  broker        Broker?    @relation(fields: [brokerId], references: [id])
  candidate     Candidate? @relation(fields: [candidateId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  placement     Placement? @relation(fields: [placementId], references: [id])
  createdByUser User?      @relation("PaymentCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?      @relation("PaymentUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([tenantId, referenceNo])
  @@index([tenantId, status])
  @@map("payments")
}

model Invoice {
  id          Int           @id @default(autoincrement())
  tenantId    Int
  referenceNo String        @unique
  payerName   String?
  amount      Decimal       
  currency    String?       @default("KES")
  status      String @default("PENDING")
  dueDate     DateTime?
  issuedDate  DateTime?
  notes       String?
  pdfUrl      String?
  createdBy   Int?
  updatedBy   Int?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id])
  createdByUser User?  @relation("InvoiceCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?  @relation("InvoiceUpdatedBy", fields: [updatedBy], references: [id])

  @@index([tenantId, status])
  @@map("invoices")
}

model Notification {
  id          Int                 @id @default(autoincrement())
  tenantId    Int
  userId      Int?
  channel     String
  templateKey String
  payload     String?
  status      String  @default("QUEUED")
  sentAt      DateTime?
  createdBy   Int?
  updatedBy   Int?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id])
  user          User?  @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdByUser User?  @relation("NotificationCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?  @relation("NotificationUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId, status])
  @@map("notifications")
}

model Setting {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  key       String
  value     String
  createdBy Int?
  updatedBy Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id])
  createdByUser User?  @relation("SettingCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?  @relation("SettingUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([tenantId, key])
  @@map("settings")
}

model Message {
  id          Int       @id @default(autoincrement())
  tenantId    Int
  senderId    Int
  recipientId Int
  subject     String
  message     String    
  isRead      Boolean   @default(false)
  readAt      DateTime?
  parentId    Int? // For replies/threading
  attachments String? // Array of attachment URLs
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  sender    User      @relation("MessageSender", fields: [senderId], references: [id], onDelete: NoAction)
  recipient User      @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: NoAction)
  parent    Message?  @relation("MessageReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   Message[] @relation("MessageReplies")

  @@index([tenantId, recipientId, isRead])
  @@index([tenantId, senderId])
  @@map("messages")
}

model SupportTicket {
  id           Int            @id @default(autoincrement())
  tenantId     Int
  userId       Int
  ticketNumber String         @unique
  subject      String
  description  String         
  category     String // e.g., "Technical", "Enrollment", "Certificate", "General"
  priority     String @default("MEDIUM")
  status       String   @default("OPEN")
  assignedTo   Int?
  resolution   String?        
  resolvedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  tenant         Tenant                 @relation(fields: [tenantId], references: [id])
  user           User                   @relation("TicketCreatedBy", fields: [userId], references: [id], onDelete: NoAction)
  assignedToUser User?                  @relation("TicketAssignedTo", fields: [assignedTo], references: [id], onDelete: NoAction, onUpdate: NoAction)
  comments       SupportTicketComment[]

  @@index([tenantId, status])
  @@index([tenantId, userId])
  @@map("support_tickets")
}

model SupportTicketComment {
  id         Int      @id @default(autoincrement())
  ticketId   Int
  userId     Int
  comment    String   
  isInternal Boolean  @default(false) // Internal notes visible only to admins
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id], onDelete: NoAction)

  @@index([ticketId])
  @@map("support_ticket_comments")
}





// ===================================
// COHORT MANAGEMENT MODELS
// ===================================

model Cohort {
  id                 Int          @id @default(autoincrement())
  tenantId           Int
  courseId           Int
  cohortCode         String       @unique 
  cohortName         String       
  description        String?      
  startDate          DateTime
  endDate            DateTime
  enrollmentDeadline DateTime
  maxCapacity        Int
  currentEnrollment  Int          @default(0)
  status             String @default("DRAFT")
  leadTrainerId      Int?
  location           String?      
  scheduleInfo       String?      

  // Computed metrics (updated via triggers/jobs)
  attendanceRate        Float? @default(0)
  assessmentAverage     Float? @default(0)
  vettingCompletionRate Float? @default(0)
  placementReadyCount   Int    @default(0)

  createdBy Int
  updatedBy Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id])
  course        Course @relation(fields: [courseId], references: [id])
  leadTrainer   User?  @relation("CohortLeadTrainer", fields: [leadTrainerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdByUser User   @relation("CohortCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?  @relation("CohortUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  enrollments       CohortEnrollment[]
  sessions          CohortSession[]
  progressSummaries CohortProgressSummary[]

  @@index([tenantId, courseId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("cohorts")
}

model CohortEnrollment {
  id              Int                    @id @default(autoincrement())
  cohortId        Int
  candidateId     Int
  enrollmentId    Int? // Link to main enrollment record
  applicationDate DateTime               @default(now())
  approvalDate    DateTime?
  status          String @default("APPLIED")

  // Progress tracking
  attendanceCount     Int           @default(0)
  totalSessions       Int           @default(0)
  attendanceRate      Float         @default(0)
  assessmentsPassed   Int           @default(0)
  assessmentsFailed   Int           @default(0)
  vettingStatus       String @default("PENDING")
  certificationIssued Boolean       @default(false)
  placementReady      Boolean       @default(false)

  reviewedBy       Int?
  reviewNotes      String?   
  withdrawalReason String?   
  withdrawalDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cohort     Cohort      @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  candidate  Candidate   @relation(fields: [candidateId], references: [id])
  enrollment Enrollment? @relation(fields: [enrollmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reviewer   User?       @relation("CohortEnrollmentReviewer", fields: [reviewedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([cohortId, candidateId])
  @@index([cohortId, status])
  @@index([candidateId])
  @@map("cohort_enrollments")
}

model CohortSession {
  id            Int           @id @default(autoincrement())
  cohortId      Int
  sessionNumber Int
  sessionTitle  String        
  sessionDate   DateTime
  startTime     DateTime
  endTime       DateTime
  facilitatorId Int?
  location      String?       
  topics        String?       
  materials     String?       
  status        String @default("SCHEDULED")

  // Actual timing
  actualStartTime DateTime?
  actualEndTime   DateTime?

  // Attendance tracking
  expectedAttendees Int   @default(0)
  actualAttendees   Int   @default(0)
  attendanceRate    Float @default(0)

  notes     String?  
  createdBy Int
  updatedBy Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cohort        Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  facilitator   User?  @relation("SessionFacilitator", fields: [facilitatorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdByUser User   @relation("SessionCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByUser User?  @relation("SessionUpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([cohortId])
  @@index([sessionDate])
  @@map("cohort_sessions")
}

model CohortProgressSummary {
  id          Int      @id @default(autoincrement())
  cohortId    Int
  summaryDate DateTime @default(now())

  // Enrollment metrics
  totalEnrolled     Int
  activeStudents    Int
  withdrawnStudents Int

  // Attendance metrics
  totalSessionsScheduled     Int
  totalSessionsCompleted     Int
  overallAttendanceRate      Float
  studentsWithPoorAttendance Int // < 75%

  // Assessment metrics
  totalAssessmentsScheduled Int
  totalAssessmentsCompleted Int
  averageScore              Float
  passRate                  Float
  studentsPassedAll         Int
  studentsWithFailures      Int

  // Vetting metrics
  vettingPending        Int
  vettingInProgress     Int
  vettingCleared        Int
  vettingRejected       Int
  vettingCompletionRate Float

  // Certification metrics
  certificatesIssued  Int
  certificatesPending Int

  // Placement metrics
  placementReady      Int
  placementInProgress Int
  placementCompleted  Int
  placementReadyRate  Float

  generatedBy Int?
  notes       String?  
  createdAt   DateTime @default(now())

  cohort          Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  generatedByUser User?  @relation(fields: [generatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([cohortId, summaryDate])
  @@map("cohort_progress_summaries")
}
